
from os.path import join

configfile: "config.yaml"

####################################
# Define some useful directories
####################################

## Data directories
TCGA_DIR = config["tcga_dir"]
REACTOME_DIR = config["reactome_dir"]

RESULT_DIR = config["result_dir"]
## Simulation study directories
SIM_DIR = join(RESULT_DIR, "simulation_study")
SIM_DATA_DIR = join(SIM_DIR, "data_hdfs")
SIM_PWY_DIR = join(SIM_DIR, "pathway_jsons")
SIM_PARAM_DIR = join(SIM_DIR, "true_parameters")
SIM_INFER_DIR = join(SIM_DIR, "inferred_parameters")
SIM_SCORE_DIR = join(SIM_DIR, "scores")


####################################
# Unpack simulation study parameters
####################################
SIM_PARAMS = config["sim_params"]
SIM_DATA_PARAMS = SIM_PARAMS["data_params"]
SIM_REPS = list(range(SIM_DATA_PARAMS["reps"]))
SIM_SNR = SIM_DATA_PARAMS["snr"]
SIM_TRUE_K = SIM_DATA_PARAMS["true_K"]

SIM_MATFAC_PARAMS = SIM_PARAMS["matfac_params"]
SIM_MAX_EPOCHS = SIM_MATFAC_PARAMS["max_epochs"]
SIM_LR = SIM_MATFAC_PARAMS["lr"]
SIM_LAMBDA_LAYER = SIM_MATFAC_PARAMS["lambda_layer"]
SIM_LAMBDA_X = SIM_MATFAC_PARAMS["lambda_X"]
SIM_LAMBDA_Y = SIM_MATFAC_PARAMS["lambda_Y"]
SIM_USED_K = SIM_MATFAC_PARAMS["used_K"]


rule all:
    input:
       inferred=expand(join(SIM_INFER_DIR,"usedk={usedk}_truek={truek}_snr={snr}_rep={rep}.hdf"),
                       usedk=SIM_USED_K, truek=SIM_TRUE_K, snr=SIM_SNR, rep=SIM_REPS)

rule run_matfac:
    input:
        src="scripts/run_matfac.jl",
        data=join(SIM_DATA_DIR, "truek={truek}_snr={snr}_rep={rep}.hdf"),
        pwy_json=join(SIM_PWY_DIR, "usedk={usedk}.json")
    output:
        inferred_bson=join(SIM_INFER_DIR, "usedk={usedk}_truek={truek}_snr={snr}_rep={rep}.bson"),
        inferred_hdf=join(SIM_INFER_DIR, "usedk={usedk}_truek={truek}_snr={snr}_rep={rep}.hdf")
    threads: 4
    shell:
        "julia --threads={threads} --project=. {input.src} {input.data} {input.pwy_json} {output.inferred_bson} {output.inferred_hdf} max_epochs={SIM_MAX_EPOCHS} lr={SIM_LR} lambda_layer={SIM_LAMBDA_LAYER} lambda_X={SIM_LAMBDA_X} lambda_Y={SIM_LAMBDA_Y}"

# NOTICE for now we have usedk==truek
rule simulate_data:
    input:
        src="scripts/simulate_data.jl",
        pwy_json=join(SIM_PWY_DIR, "usedk={truek}.json"), 
        sample_json=join(TCGA_DIR, "tcga_samples.json"),
        feature_json=join(TCGA_DIR, "tcga_features.json")
    output:
        data_hdf=join(SIM_DATA_DIR, "truek={truek}_snr={snr}_rep={rep}.hdf"),
        param_hdf=join(SIM_PARAM_DIR, "truek={truek}_snr={snr}_rep={rep}.hdf")
    threads: 4
    shell:
        "julia --threads={threads} --project=. {input.src} {input.pwy_json} {input.sample_json} {input.feature_json} {output.data_hdf} {output.param_hdf} snr={wildcards.snr}"
   

rule select_used_pwys:
    input:
        src="scripts/select_pathways.py",
        feature_json=join(TCGA_DIR, "tcga_features.json"),
        all_pwy_json=join(REACTOME_DIR, "reactome.json"),
    output:
        pwy_json=join(SIM_PWY_DIR, "usedk={usedk}.json"),
    shell:
        "python {input.src} {input.all_pwy_json} {input.feature_json} {wildcards.usedk} {output.pwy_json}"


rule reactome_txt_to_json:
    input:
        src="scripts/reactome_txt_to_json.py",
        txt=join(REACTOME_DIR, "reactome.hgnc.txt"),
    output:
        json=join(REACTOME_DIR, "reactome.json")
    shell:
        "python {input.src} {input.txt} {output.json}"



